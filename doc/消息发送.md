<!--
 * @LastEditors: liushuxin
 * @LastEditTime: 2024-05-12 19:36:33
 * @FilePath: /BT/doc/消息发送.md
 * @Description: 
 * 
 * Copyright (c) 2024 by liushuxina@gmail.com All Rights Reserved. 
-->

# 消息发送

## 发送文本消息

1. 对原始文本消息进行预处理，主要是添加指定前缀（`\\s`），并且将原始文本中与前缀相同的文本全部替换为空串
2. 构造文本消息实体
3. 将消息状态设置为发送中，更新数据库并通过通知更新UI
4. 调用 API 向对方发送消息
5. 文本消息送成功/失败后，将数据库中消息的状态更新为对应的成功/失败状态，并通过通知修改UI；

## 发送图片消息

1. 构造 DDMessageEntity，将消息状态设置为发送中，插入数据库并通过通知更新UI
2. 上传图片到服务器
3. 图片上传完成后，调用 API 向对方发送图片消息
4. 图片发送成功/失败后，将数据库中消息的状态更新为对应的成功/失败状态，并通过通知修改UI；

## 发送语音消息

1. 将录音时长数据（32位）以二进制形式添加到录音原始数据的末尾
2. 构造 DDMessageEntity，将消息状态设置为正在发送中，插入数据库并通过通知更新UI
3. 上传语音到文件服务器
4. 上传完成后调用 API 向对方发送语音消息
5. 语音消息发送成功/失败后，将数据库中的消息状态更新为对应的成功失败状态，并通过通知修改UI